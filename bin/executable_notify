#!/bin/bash

title="$1"
shift
message="$@"

if ! command -v osascript &>/dev/null; then
    echo "notify: osascript required (for now)" >&2
    exit 1
fi

front_app=$(osascript -e '
    tell application "System Events"
        set frontProcess to first application process whose frontmost is true
        set bid to bundle identifier of frontProcess
    end tell
    return bid
' 2>/dev/null)

is_vscode() {
    [ "$TERM_PROGRAM" = "vscode" ] || \
        [ "$CLAUDE_CODE_ENTRYPOINT" = "claude-vscode" ]
}

is_tmux_pane_visible() {
    [ -z "$TMUX" ] && return 1

    local attached=$(tmux display-message -p '#{session_attached}')
    [ "$attached" != "1" ] && return 1

    local my_pane="$TMUX_PANE"

    # list-panes -s evaluates #{window_active} and #{pane_active} for EACH
    # pane. "11" means: window is active AND pane is active within that window.
    tmux list-panes -s -F '#{window_active}#{pane_active} #{pane_id}' \
        | grep -q "^11 ${my_pane}$"
}

if is_vscode; then
    [ "$front_app" = "com.microsoft.VSCode" ] && exit 0
elif [ "$front_app" = "com.apple.Terminal" ] && is_tmux_pane_visible; then
    exit 0
fi

osascript -e "display notification \"$message\" with title \"$title\""
